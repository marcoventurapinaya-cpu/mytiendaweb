<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tienda Virtual - Mi Negocio</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #1a73e8, #0d47a1);
      color: white;
      text-align: center;
      padding: 30px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0;
      font-weight: 600;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .search-box {
      margin: 15px 0;
      text-align: center;
    }
    .search-box input {
      width: 80%;
      max-width: 500px;
      padding: 12px 16px;
      border: 2px solid #1a73e8;
      border-radius: 30px;
      font-size: 16px;
      outline: none;
    }

    .categories {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    .category-btn {
      padding: 10px 16px;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
    }
    .category-btn:hover {
      background-color: #1557b0;
    }

    .admin-section {
      background: white;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    .admin-section h3 {
      margin: 0 0 15px;
      color: #1a73e8;
    }
    .admin-btn {
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    input[type="file"] {
      margin: 10px 0;
    }

    .add-form {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .add-form input, .add-form select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .add-form button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 8px;
    }

    .products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
    }
    .product {
      background: white;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .product h3 {
      margin: 0 0 10px;
      color: #1a73e8;
      font-size: 1.2em;
    }
    .product p {
      margin: 6px 0;
      font-size: 15px;
      color: #555;
    }
    .price-unit {
      font-weight: 600;
      color: #2e7d32;
    }
    .price-bulk {
      font-weight: 500;
      color: #d81b60;
    }
    .btn-add {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-add:hover {
      background-color: #1557b0;
    }
    .btn-pack {
      background-color: #0d47a1;
    }

    .cart {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      padding: 20px;
      width: 350px;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    .cart-header h3 {
      margin: 0;
      color: #1a73e8;
    }
    .close-cart {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 6px 0;
      border-bottom: 1px dashed #eee;
      font-size: 15px;
    }
    .cart-total {
      margin-top: 20px;
      font-weight: bold;
      text-align: right;
      color: #1a73e8;
      font-size: 1.2em;
    }
    .cart-actions {
      margin-top: 15px;
      text-align: right;
    }
    .btn-checkout {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
    }

    .receipt-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .receipt-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .receipt-header {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 20px;
    }
    .receipt-items {
      margin: 15px 0;
    }
    .receipt-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    .receipt-total {
      text-align: right;
      font-weight: bold;
      margin-top: 20px;
      font-size: 1.3em;
      color: #1a73e8;
    }
    .receipt-btns {
      text-align: right;
      margin-top: 20px;
    }
    .btn-print, .btn-close-receipt {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }
    .btn-print { background: #1a73e8; color: white; }
    .btn-close-receipt { background: #999; color: white; }

    .show-cart { display: block; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <header>
    <h1>üè™ Mi Tienda Virtual</h1>
    <p>Compra f√°cil y r√°pido</p>
  </header>

  <div class="container">

    <!-- B√∫squeda -->
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Buscar producto..." oninput="searchProduct()">
    </div>

    <!-- Secci√≥n de administraci√≥n -->
    <div class="admin-section">
      <h3>üõ†Ô∏è Administraci√≥n</h3>

      <!-- Formulario para agregar producto -->
      <div class="add-form">
        <h4>‚ûï Agregar Producto</h4>
        <input type="text" id="prod-name" placeholder="Nombre del producto">
        <input type="number" id="prod-price" placeholder="Precio por unidad (Bs.)" step="0.01">
        <input type="number" id="prod-bulk-price" placeholder="Precio por mayor (Bs.)" step="0.01">
        <input type="text" id="prod-bulk-desc" placeholder="Descripci√≥n del paquete (ej: Paquete 6 und)">
        <select id="prod-category">
          <!-- Las categor√≠as se cargar√°n din√°micamente -->
        </select>
        <button onclick="addProduct()">Agregar Producto</button>
      </div>

      <!-- A√±adir nueva categor√≠a -->
      <div class="add-form" style="margin-top: 15px;">
        <h4>‚ûï A√±adir Nueva Categor√≠a</h4>
        <input type="text" id="new-category" placeholder="Nombre de la nueva categor√≠a (ej: Dulces)">
        <button onclick="addNewCategory()">Agregar Categor√≠a</button>
      </div>

      <!-- Carga desde Excel -->
      <label class="admin-btn">
        üìÇ Cargar desde Excel
        <input type="file" id="upload-excel" accept=".xlsx, .xls" style="display: none;" onchange="handleFile(this.files)">
      </label>
      <a class="admin-btn" href="#" onclick="downloadTemplate()" style="text-decoration: none;">üìã Descargar Plantilla</a>
    </div>

    <!-- Categor√≠as -->
    <div class="categories" id="categories-container">
      <!-- Se llenar√° din√°micamente -->
    </div>

    <!-- Productos -->
    <div class="products" id="product-list">
      <!-- Se llenar√° din√°micamente -->
    </div>

  </div>

  <!-- Bot√≥n flotante del carrito -->
  <button style="position: fixed; bottom: 20px; right: 20px; background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 50%; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 10;" onclick="toggleCart()">
    üõí <span id="cart-count">0</span>
  </button>

  <!-- Carrito -->
  <div class="cart" id="cart">
    <div class="cart-header">
      <h3>Tu Compra</h3>
      <button class="close-cart" onclick="toggleCart()">‚úï</button>
    </div>
    <div id="cart-items">
      <p id="empty-cart">Tu carrito est√° vac√≠o.</p>
    </div>
    <div class="cart-total" id="cart-total">Total: 0,00 Bs.</div>
    <div class="cart-actions">
      <button class="btn-checkout" onclick="checkout()">Finalizar Compra</button>
    </div>
  </div>

  <!-- Recibo -->
  <div class="receipt-modal" id="receipt-modal">
    <div class="receipt-content">
      <div class="receipt-header">
        <h2>üìÑ Recibo de Compra</h2>
        <p>Mi Tienda Virtual</p>
        <p><small>Fecha: <span id="receipt-date"></span></small></p>
      </div>
      <div id="receipt-items" class="receipt-items"></div>
      <div class="receipt-total" id="receipt-total">Total: 0,00 Bs.</div>
      <div class="receipt-btns">
        <button class="btn-close-receipt" onclick="closeReceipt()">Cerrar</button>
        <button class="btn-print" onclick="printReceipt()">Imprimir</button>
      </div>
    </div>
  </div>

  <script>
    // Claves de almacenamiento
    const STORAGE_PRODUCTS = 'mi_tienda_productos_vfinal';
    const STORAGE_CATEGORIES = 'mi_tienda_categorias_v1';

    // Cargar productos
    let products = JSON.parse(localStorage.getItem(STORAGE_PRODUCTS)) || [
      { name: "Coca-Cola 3L", price: 18.00, bulkPrice: 105.00, bulkDesc: "Paquete 6 und", category: "gaseosas" },
      { name: "Papel Higi√©nico 4 rollos", price: 12.00, bulkPrice: 135.00, bulkDesc: "Paquete 12 und", category: "papel higienico" },
      { name: "Agua Vital 1L", price: 8.50, bulkPrice: 96.00, bulkDesc: "Paquete 12 und", category: "aguas" }
    ];

    // Cargar categor√≠as (incluyendo "papel higienico")
    let categories = JSON.parse(localStorage.getItem(STORAGE_CATEGORIES)) || [
      "gaseosas",
      "jugos",
      "aguas",
      "cerveza",
      "tragos",
      "panales",
      "plasticos",
      "limpieza",
      "galletas",
      "papel higienico"  // ‚Üê Nueva categor√≠a
    ];

    let cart = [];

    // Guardar productos y categor√≠as
    function saveProducts() {
      localStorage.setItem(STORAGE_PRODUCTS, JSON.stringify(products));
    }
    function saveCategories() {
      localStorage.setItem(STORAGE_CATEGORIES, JSON.stringify(categories));
    }

    // Cargar categor√≠as en men√∫s
    function loadCategories() {
      const container = document.getElementById('categories-container');
      const select = document.getElementById('prod-category');
      
      // Limpiar
      container.innerHTML = '';
      select.innerHTML = '<option value="">Seleccionar categor√≠a</option>';

      // Agregar "Todos"
      const btnAll = document.createElement('button');
      btnAll.className = 'category-btn';
      btnAll.textContent = 'Todos';
      btnAll.onclick = () => filterCategory('all');
      container.appendChild(btnAll);

      // Agregar cada categor√≠a
      categories.forEach(cat => {
        const safeCat = cat.toLowerCase().replace(/\s+/g, ''); // "papel higienico" ‚Üí "papelhigienico"
        
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.textContent = capitalize(cat);
        btn.onclick = () => filterCategory(safeCat);
        container.appendChild(btn);

        const option = document.createElement('option');
        option.value = safeCat;
        option.textContent = capitalize(cat);
        select.appendChild(option);
      });
    }

    // Capitalizar texto
    function capitalize(str) {
      return str.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    // Cargar productos
    function loadProducts() {
      const container = document.getElementById('product-list');
      container.innerHTML = '';
      products.forEach(p => {
        const safeCat = p.category.toLowerCase().replace(/\s+/g, '');
        const div = document.createElement('div');
        div.className = 'product';
        div.setAttribute('data-category', safeCat);
        div.setAttribute('data-name', p.name.toLowerCase());
        div.innerHTML = `
          <h3>${p.name}</h3>
          <p><strong>Precio Unidad:</strong> <span class="price-unit">${p.price.toFixed(2)} Bs.</span></p>
          <p><strong>${p.bulkDesc}:</strong> <span class="price-bulk">${p.bulkPrice.toFixed(2)} Bs.</span></p>
          <button class="btn-add" onclick="addToCart('${p.name}', ${p.price})">A√±adir Unidad</button>
          <button class="btn-add btn-pack" onclick="addToCart('${p.name} (${p.bulkDesc})', ${p.bulkPrice})">A√±adir ${p.bulkDesc}</button>
        `;
        container.appendChild(div);
      });
    }

    // A√±adir producto
    function addProduct() {
      const name = document.getElementById('prod-name').value.trim();
      const price = parseFloat(document.getElementById('prod-price').value);
      const bulkPrice = parseFloat(document.getElementById('prod-bulk-price').value);
      const bulkDesc = document.getElementById('prod-bulk-desc').value.trim();
      const category = document.getElementById('prod-category').value;

      if (!name || isNaN(price) || isNaN(bulkPrice) || !bulkDesc || !category) {
        alert("Completa todos los campos.");
        return;
      }

      // Buscar categor√≠a original para mostrar bien
      const displayCategory = categories.find(c => c.toLowerCase().replace(/\s+/g, '') === category) || "otros";

      products.push({ 
        name, 
        price, 
        bulkPrice, 
        bulkDesc, 
        category: displayCategory 
      });
      saveProducts();
      loadProducts();
      alert("‚úÖ Producto agregado.");
      clearForm();
    }

    function clearForm() {
      document.getElementById('prod-name').value = '';
      document.getElementById('prod-price').value = '';
      document.getElementById('prod-bulk-price').value = '';
      document.getElementById('prod-bulk-desc').value = '';
      document.getElementById('prod-category').value = '';
    }

    // A√±adir nueva categor√≠a
    function addNewCategory() {
      const input = document.getElementById('new-category');
      const name = input.value.trim();
      if (!name) {
        alert("Escribe un nombre de categor√≠a.");
        return;
      }

      const safeName = name.toLowerCase().replace(/\s+/g, '');
      const exists = categories.some(cat => cat.toLowerCase().replace(/\s+/g, '') === safeName);
      if (exists) {
        alert("Esta categor√≠a ya existe.");
        return;
      }

      categories.push(name);
      saveCategories();
      loadCategories();
      input.value = '';
      alert(`‚úÖ Categor√≠a "${name}" agregada.`);
    }

    // Manejar carga de Excel
    function handleFile(fileList) {
      if (!fileList.length) return;
      const file = fileList[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);

          let added = 0;
          json.forEach(row => {
            if (!row.nombre || !row.precio || !row.precio_mayor || !row.descripcion_mayor || !row.categoria) return;
            
            // A√±adir categor√≠a si no existe
            const catNorm = row.categoria.toLowerCase().replace(/\s+/g, '');
            if (!categories.some(c => c.toLowerCase().replace(/\s+/g, '') === catNorm)) {
              categories.push(row.categoria);
            }

            products.push({
              name: row.nombre,
              price: parseFloat(row.precio),
              bulkPrice: parseFloat(row.precio_mayor),
              bulkDesc: row.descripcion_mayor,
              category: row.categoria
            });
            added++;
          });
          saveCategories();
          saveProducts();
          loadCategories();
          loadProducts();
          alert(`‚úÖ ${added} productos cargados desde Excel.`);
        } catch (error) {
          alert("‚ùå Error al leer el archivo.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Descargar plantilla
    function downloadTemplate() {
      const data = [
        ["nombre", "precio", "precio_mayor", "descripcion_mayor", "categoria"],
        ["Papel Higi√©nico 4R", 12.00, 135.00, "Paquete 12 und", "papel higienico"],
        ["Coca-Cola 3L", 18.00, 105.00, "Paquete 6 und", "gaseosas"]
      ];
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Productos");
      XLSX.writeFile(wb, "plantilla_productos_tienda.xlsx");
    }

    // B√∫squeda
    function searchProduct() {
      const term = document.getElementById('search-input').value.toLowerCase();
      const productsList = document.querySelectorAll('.product');
      productsList.forEach(p => {
        const name = p.getAttribute('data-name');
        const category = p.getAttribute('data-category');
        const matches = name.includes(term) || category.includes(term);
        p.style.display = matches ? 'block' : 'none';
      });
    }

    // Filtrar por categor√≠a
    function filterCategory(category) {
      document.getElementById('search-input').value = '';
      const productsList = document.querySelectorAll('.product');
      productsList.forEach(p => {
        p.style.display = (category === 'all' || p.getAttribute('data-category') === category) ? 'block' : 'none';
      });
    }

    // Carrito
    function addToCart(name, price) {
      const item = cart.find(i => i.name === name);
      if (item) item.quantity += 1;
      else cart.push({ name, price, quantity: 1 });
      updateCart();
    }

    function updateCart() {
      const itemsEl = document.getElementById('cart-items');
      const totalEl = document.getElementById('cart-total');
      const countEl = document.getElementById('cart-count');
      itemsEl.innerHTML = '';
      if (cart.length === 0) {
        itemsEl.innerHTML = '<p id="empty-cart">Vac√≠o</p>';
        totalEl.textContent = 'Total: 0,00 Bs.';
        countEl.textContent = '0';
        return;
      }
      let total = 0, count = 0;
      cart.forEach(item => {
        const t = item.price * item.quantity;
        total += t; count += item.quantity;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `<span>${item.name}</span><span>${t.toFixed(2)} Bs.</span>`;
        itemsEl.appendChild(div);
      });
      totalEl.textContent = `Total: ${total.toFixed(2)} Bs.`;
      countEl.textContent = count;
    }

    function toggleCart() {
      document.getElementById('cart').classList.toggle('show-cart');
    }

    // Finalizar compra
    function checkout() {
      if (cart.length === 0) {
        alert("Vac√≠o");
        return;
      }
      const receiptItems = document.getElementById('receipt-items');
      const receiptTotal = document.getElementById('receipt-total');
      receiptItems.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        const t = item.price * item.quantity;
        total += t;
        const p = document.createElement('div');
        p.className = 'receipt-item';
        p.innerHTML = `<span>${item.name}</span><span>${t.toFixed(2)} Bs.</span>`;
        receiptItems.appendChild(p);
      });
      receiptTotal.textContent = `Total: ${total.toFixed(2)} Bs.`;
      document.getElementById('receipt-date').textContent = new Date().toLocaleString('es-BO');
      document.getElementById('receipt-modal').style.display = 'flex';
      toggleCart();
      cart = []; updateCart();
    }

    function closeReceipt() {
      document.getElementById('receipt-modal').style.display = 'none';
    }

    function printReceipt() {
      const c = document.querySelector('.receipt-content').innerHTML;
      const d = document.body.innerHTML;
      document.body.innerHTML = c;
      window.print();
      document.body.innerHTML = d;
    }

    // Inicializar
    window.onload = function() {
      loadCategories();
      loadProducts();
      updateCart();
    };
  </script>
</body>
</html>    
